
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>pietrushnic's world</title>
  <meta name="author" content="pietrushnic">

  
  <meta name="description" content="Table of contents Introduction
Get and build BusyBox
Fast and simple
Setting up kernel through NFS
Verify Configuration
Embedded filesystem tuning &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pietrushnic.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="pietrushnic's world" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39420295-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">pietrushnic's world</a></h1>
  
    <h2>|| 933k' dr34M2 0F Phr33D0m</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pietrushnic.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/07/root-file-system-for-embedded-system/">0x6: Root file system for embedded system</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-07T10:40:00+02:00" pubdate data-updated="true">Jun 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Table of contents</h2>

<ul>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#intro">Introduction</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#get-bb">Get and build BusyBox</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#fast-and-simple">Fast and simple</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#setting-up-kernel-through-nfs">Setting up kernel through NFS</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#verify-configuration">Verify Configuration</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#embedded-filesystem-tuning">Embedded filesystem tuning</a></li>
<li><a href="/blog/2013/06/07/root-file-system-for-embedded-system/#summary">Summary</a></li>
</ul>


<p><a id="intro"></a></p>

<h3>Introduction</h3>

<p>To make our embedded linux work as virtual development platform we need some
environment after booting. There is many approaches to get working root file
system but I will use the easiest one as an exercise. I don&rsquo;t want to create full
embedded distribution (this is good plan for future works). Right now I will be
happy with simple initramfs based on <a href="http://busybox.net/">BusyBox</a>.</p>

<p>For all interested in creating own root filesystem there are few places where
you can find informations:</p>

<ul>
<li><a href="http://lwn.net/Articles/210046/">Embedded Linux: Small Root Filesystems</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt">ramfs-rootfs-initramfs</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/Creating_a_Root_File_System_for_Linux_on_OMAP35x">Creating a Root File System for Linux on OMAP35x</a></li>
</ul>


<p><a id="get-bb"></a></p>

<h3>Get and build BusyBox</h3>

<p>Clone git repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://git.busybox.net/busybox</span></code></pre></td></tr></table></div></figure>


<p><a id="fast-and-simple"></a></p>

<h3>Fast and simple</h3>

<p>Of course make sure to use correct toolchain. I made few notes about
Ubuntu/Linaro toolchain in <a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#ubuntu-issues">previous post</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig</span></code></pre></td></tr></table></div></figure>


<p>Mark <code>Busybox Settings -&gt; Build Options -&gt; Build BusyBox as a static binary (no
shared libs)</code> option. Exit and save.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
</span><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- install
</span><span class='line'>cd _install/</span></code></pre></td></tr></table></div></figure>


<p><a id="setting-up-kernel-through-nfs"></a></p>

<h3>Setting up kernel through NFS</h3>

<p><a href="/blog/2013/06/07/linux-kernel-for-embedded-system">Previously</a> we prepared U-Boot
kenernel image with DHCP and rootfs which we want to expose over NFS. First lets start with NFS
configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install nfs-kernel-server</span></code></pre></td></tr></table></div></figure>


<p>I use simple <code>/etc/exports</code> configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/srv/homes 192.168.1.0/255.255.255.0(rw,sync,no_subtree_check,no_root_squash)</span></code></pre></td></tr></table></div></figure>


<p>Make sure that <code>/srv/homes</code> exist, if no than create it. After editing nfs
configuration file we have to restart NFS server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo service nfs-kernel-server restart</span></code></pre></td></tr></table></div></figure>


<p><a id="verify-configuration"></a></p>

<h3>Verify configuration</h3>

<p>I assume that you go through all previous articles in this series.
To verify configuration we have to copy whole BusyBox <code>_install</code> directory to
known nfs location:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /srv/homes/rootfs
</span><span class='line'>sudo chmod 777 /srv/homes/rootfs
</span><span class='line'>cd /srv/homes/rootfs
</span><span class='line'>cp -R /path/to/busybox/_install/* .</span></code></pre></td></tr></table></div></figure>


<p>Now we can try our Virtual Development Board:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo qemu-system-arm -kernel src/u-boot/u-boot -net nic,vlan=0 -net \
</span><span class='line'>tap,vlan=0,ifname=tap0,script=/etc/qemu-ifup -nographic -M versatilepb</span></code></pre></td></tr></table></div></figure>


<p>After U-Boot booting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VersatilePB # setenv autload no
</span><span class='line'>VersatilePB # dhcp
</span><span class='line'>MC91111: PHY auto-negotiate timed out
</span><span class='line'>SMC91111: MAC 52:54:00:12:34:56
</span><span class='line'>BOOTP broadcast 1
</span><span class='line'>DHCP client bound to address 192.168.1.13
</span><span class='line'>VersatilePB # setenv serverip 192.168.1.24
</span><span class='line'>VersatilePB # setenv bootfile uImage
</span><span class='line'>VersatilePB # tftp</span></code></pre></td></tr></table></div></figure>


<p>Note that <code>192.168.1.24</code> should be replaced with correct address of TFTP server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VersatilePB # tftp
</span><span class='line'>SMC91111: PHY auto-negotiate timed out
</span><span class='line'>SMC91111: MAC 52:54:00:12:34:56
</span><span class='line'>Using SMC91111-0 device
</span><span class='line'>TFTP from server 192.168.1.20; our IP address is 192.168.1.13
</span><span class='line'>Filename 'uImage'.
</span><span class='line'>Load address: 0x7fc0
</span><span class='line'>Loading: #################################################################
</span><span class='line'>         #################################################################
</span><span class='line'>         #################################################################
</span><span class='line'>         #################################################################
</span><span class='line'>         #################################################################
</span><span class='line'>         ##################################################
</span><span class='line'>         252 KiB/s
</span><span class='line'>done
</span><span class='line'>Bytes transferred = 1917944 (1d43f8 hex)</span></code></pre></td></tr></table></div></figure>


<p>Right now we will set boot arguments for our kernel:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setenv bootargs 'root=/dev/nfs mem=128M ip=dhcp netdev=25,0,0xf1010000,0xf1010010,eth0 nfsroot=192.168.1.20:/srv/homes/rootfs console=ttyAMA0'</span></code></pre></td></tr></table></div></figure>


<p>What does it mean:</p>

<ul>
<li><code>root=/dev/nfs</code> &ndash; following
<a href="https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt">kernel.org</a>:</li>
</ul>


<blockquote><p>This is necessary to enable the pseudo-NFS-device. Note that it&#8217;s not a<br/>real device but just a synonym to tell the kernel to use NFS instead of<br/>a real device.</p></blockquote>


<ul>
<li><code>mem=128M ip=dhcp</code> &ndash; self-explaining</li>
<li><code>netdev=25,0,0xf1010000,0xf1010010,eth0</code> &ndash; network device configuration
(<code>Format: &lt;irq&gt;,&lt;io&gt;,&lt;mem_start&gt;,&lt;mem_end&gt;,&lt;name&gt;</code>), this was provided by
default <code>U-Boot</code> bootargs</li>
<li><code>nfsroot=192.168.1.20:/srv/homes/rootfs</code> &ndash; NFS server ip and path to rootfs</li>
<li><code>console=ttyAMA0</code> &ndash; very importanat if you want to see anything in <code>-nographic</code> mode</li>
</ul>


<p>After setting bootargs we can boot our Virtual Development Board:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bootm</span></code></pre></td></tr></table></div></figure>


<p>As you can see that&rsquo;s not all, our current configuration end with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(...)
</span><span class='line'>Sending DHCP requests .input: AT Raw Set 2 keyboard as 
</span><span class='line'>/devices/fpga:06/serio0/input/input0
</span><span class='line'>, OK
</span><span class='line'>IP-Config: Got DHCP answer from 192.168.1.1, my address is 192.168.1.13
</span><span class='line'>IP-Config: Complete:
</span><span class='line'>     device=eth0, hwaddr=52:54:00:12:34:56, ipaddr=192.168.1.13, mask=255.255.255.0, gw=192.168.1.1
</span><span class='line'>     host=192.168.1.13, domain=, nis-domain=(none)
</span><span class='line'>     bootserver=0.0.0.0, rootserver=192.168.1.20, rootpath=
</span><span class='line'>     nameserver0=192.168.1.1
</span><span class='line'>input: ImExPS/2 Generic Explorer Mouse as 
</span><span class='line'>/devices/fpga:07/serio1/input/input1
</span><span class='line'>VFS: Mounted root (nfs filesystem) on device 0:9.
</span><span class='line'>Freeing unused kernel memory: 112K (c034e000 - c036a000)
</span><span class='line'>nfs: server 192.168.1.20 not responding, still trying
</span><span class='line'>nfs: server 192.168.1.20 OK
</span><span class='line'>can't run '/etc/init.d/rcS': No such file or directory
</span><span class='line'>can't open /dev/tty2: No such file or directory
</span><span class='line'>can't open /dev/tty3: No such file or directory
</span><span class='line'>
</span><span class='line'>can't open /dev/tty4: No such file or directory
</span><span class='line'>can't open /dev/tty2: No such file or directory
</span><span class='line'>can't open /dev/tty3: No such file or directory
</span><span class='line'>can't open /dev/tty4: No such file or directory
</span><span class='line'>can't open /dev/tty2: No such file or directory
</span><span class='line'>can't open /dev/tty3: No such file or directory</span></code></pre></td></tr></table></div></figure>


<p>try to open ttys loop. This is because of default behavior of <code>BusyBox</code> when <code>inittab</code>
was not found.</p>

<p><a id="embedded-filesystem-tuning"></a></p>

<h3>Embedded filesystem tuning</h3>

<p>To override above behavior we have to create <code>/etc/inittab</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd /srv/homes/rootfs
</span><span class='line'>mkdir etc
</span><span class='line'>vim etc/inittab</span></code></pre></td></tr></table></div></figure>


<p>Our <code>inittab</code> is very simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>::sysinit:/etc/init.d/rcS
</span><span class='line'>::askfirst:/bin/ash
</span><span class='line'>::ctrlaltdel:/sbin/reboot
</span><span class='line'>::shutdown:/sbin/swapoff -a
</span><span class='line'>::shutdown:/bin/umount -a -r
</span><span class='line'>::restart:/sbin/init</span></code></pre></td></tr></table></div></figure>


<p>If you want to learn more about inittab &ndash; <code>man inittab</code> .We need improve out filesystem with few directories:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir sys proc etc/init.d</span></code></pre></td></tr></table></div></figure>


<p>In <code>/etc/init.d/rcS</code> we will mount sysfs and procfs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'>mount -t proc proc /proc
</span><span class='line'>mount -t sysfs sysfs /sys
</span></code></pre></td></tr></table></div></figure>


<p>Give executable permission to <code>rcS</code> script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod +x etc/init.d/rcS
</span></code></pre></td></tr></table></div></figure>


<p>We also have to create <code>dev</code> directory with <code>ttyAMA0</code> block device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir dev
</span><span class='line'>sudo mknod dev/ttyAMA0 c 204 64
</span><span class='line'>sudo mknod dev/null c 1 3
</span><span class='line'>sudo mknod dev/console c 5 1
</span></code></pre></td></tr></table></div></figure>


<p>Right now we should be able to boot our Virtual Development Board. Let&rsquo;s try
again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pietrushnic@eglarest:~<span class="nv">$ </span>sudo qemu-system-arm -m 256M -kernel src/u-boot/u-boot -net nic,vlan<span class="o">=</span>0 -net tap,vlan<span class="o">=</span>0,ifname<span class="o">=</span>tap0,script<span class="o">=</span>/etc/qemu-ifup -nographic -M versatilepb -net dump,file<span class="o">=</span>/tmp/dump.pcap
</span><span class='line'>Executing /etc/qemu-ifup
</span><span class='line'>Bringing up tap0 <span class="k">for </span>bridged mode...
</span><span class='line'>Adding tap0 to br0...
</span><span class='line'>oss: Could not initialize DAC
</span><span class='line'>oss: Failed to open <span class="sb">`</span>/dev/dsp<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">oss: Reason: No such file or directory</span>
</span><span class='line'><span class="s1">oss: Could not initialize DAC</span>
</span><span class='line'><span class="s1">oss: Failed to open `/dev/dsp&#39;</span>
</span><span class='line'>oss: Reason: No such file or directory
</span><span class='line'>audio: Failed to create voice <span class="sb">`</span>lm4549.out<span class="s1">&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="s1">U-Boot 2013.04-00274-ga71d45d (May 27 2013 - 17:36:14)</span>
</span><span class='line'>
</span><span class='line'><span class="s1">DRAM:  128 MiB</span>
</span><span class='line'><span class="s1">WARNING: Caches not enabled</span>
</span><span class='line'><span class="s1">Flash: 64 MiB</span>
</span><span class='line'><span class="s1">*** Warning - bad CRC, using default environment</span>
</span><span class='line'>
</span><span class='line'><span class="s1">In:    serial</span>
</span><span class='line'><span class="s1">Out:   serial</span>
</span><span class='line'><span class="s1">Err:   serial</span>
</span><span class='line'><span class="s1">Net:   SMC91111-0</span>
</span><span class='line'><span class="s1">Warning: SMC91111-0 using MAC address from net device</span>
</span><span class='line'>
</span><span class='line'><span class="s1">VersatilePB # setenv serverip 192.168.1.24</span>
</span><span class='line'><span class="s1">VersatilePB # setenv bootfile uImage</span>
</span><span class='line'><span class="s1">VersatilePB # setenv bootargs &#39;</span><span class="nv">root</span><span class="o">=</span>/dev/nfs <span class="nv">mem</span><span class="o">=</span>128M <span class="nv">ip</span><span class="o">=</span>dhcp <span class="nv">netdev</span><span class="o">=</span>25,0,0xf1010000,0xf1010010,eth0 <span class="nv">nfsroot</span><span class="o">=</span>192.168.1.24:/sv/homes/rootfs <span class="nv">console</span><span class="o">=</span>ttyAMA0<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">VersatilePB # dhcp</span>
</span><span class='line'><span class="s1">SMC91111: PHY auto-negotiate timed out</span>
</span><span class='line'><span class="s1">SMC91111: MAC 52:54:00:12:34:56</span>
</span><span class='line'><span class="s1">BOOTP broadcast 1</span>
</span><span class='line'><span class="s1">DHCP client bound to address 192.168.1.13</span>
</span><span class='line'><span class="s1">Using SMC91111-0 device</span>
</span><span class='line'><span class="s1">TFTP from server 192.168.1.24; our IP address is 192.168.1.13</span>
</span><span class='line'><span class="s1">Filename &#39;</span>uImage<span class="s1">&#39;.</span>
</span><span class='line'><span class="s1">Load address: 0x7fc0</span>
</span><span class='line'><span class="s1">Loading: *############T #####################################################</span>
</span><span class='line'><span class="s1">  #################################################################</span>
</span><span class='line'><span class="s1">  #################################################################</span>
</span><span class='line'><span class="s1">  #################################################################</span>
</span><span class='line'><span class="s1">  #################################################################</span>
</span><span class='line'><span class="s1">  ##################################################</span>
</span><span class='line'><span class="s1">  0 Bytes/s</span>
</span><span class='line'><span class="s1">done</span>
</span><span class='line'><span class="s1">Bytes transferred = 1917944 (1d43f8 hex)</span>
</span><span class='line'><span class="s1">VersatilePB # bootm</span>
</span><span class='line'><span class="s1">## Booting kernel from Legacy Image at 00007fc0 ...</span>
</span><span class='line'><span class="s1">   Image Name:   Linux-3.10.0-rc3</span>
</span><span class='line'><span class="s1">   Image Type:   ARM Linux Kernel Image (uncompressed)</span>
</span><span class='line'><span class="s1">   Data Size:    1917880 Bytes = 1.8 MiB</span>
</span><span class='line'><span class="s1">   Load Address: 00008000</span>
</span><span class='line'><span class="s1">   Entry Point:  00008000</span>
</span><span class='line'><span class="s1">   XIP Kernel Image ... OK</span>
</span><span class='line'><span class="s1">OK</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Starting kernel ...</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Uncompressing Linux... done, booting the kernel.</span>
</span><span class='line'><span class="s1">Booting Linux on physical CPU 0x0</span>
</span><span class='line'><span class="s1">Linux version 3.10.0-rc3 (pietrushnic@eglarest) (gcc version 4.7.2 (Debian 4.7.2-4) ) #2 Sun Jun 2 20:25:23 CEST 2013</span>
</span><span class='line'><span class="s1">CPU: ARM926EJ-S [41069265] revision 5 (ARMv5TEJ), cr=00093177</span>
</span><span class='line'><span class="s1">CPU: VIVT data cache, VIVT instruction cache</span>
</span><span class='line'><span class="s1">Machine: ARM-Versatile PB</span>
</span><span class='line'><span class="s1">Memory policy: ECC disabled, Data cache writeback</span>
</span><span class='line'><span class="s1">sched_clock: 32 bits at 24MHz, resolution 41ns, wraps every 178956ms</span>
</span><span class='line'><span class="s1">Built 1 zonelists in Zone order, mobility grouping on.  Total pages: 32512</span>
</span><span class='line'><span class="s1">Kernel command line: root=/dev/nfs mem=128M ip=dhcp netdev=25,0,0xf1010000,0xf1010010,eth0 nfsroot=192.168.1.24:/srv/homes/rootfs console=ttyAMA0</span>
</span><span class='line'><span class="s1">PID hash table entries: 512 (order: -1, 2048 bytes)</span>
</span><span class='line'><span class="s1">Dentry cache hash table entries: 16384 (order: 4, 65536 bytes)</span>
</span><span class='line'><span class="s1">Inode-cache hash table entries: 8192 (order: 3, 32768 bytes)</span>
</span><span class='line'><span class="s1">Memory: 128MB = 128MB total</span>
</span><span class='line'><span class="s1">Memory: 126136k/126136k available, 4936k reserved, 0K highmem</span>
</span><span class='line'><span class="s1">Virtual kernel memory layout:</span>
</span><span class='line'><span class="s1">    vector  : 0xffff0000 - 0xffff1000   (   4 kB)</span>
</span><span class='line'><span class="s1">    fixmap  : 0xfff00000 - 0xfffe0000   ( 896 kB)</span>
</span><span class='line'><span class="s1">    vmalloc : 0xc8800000 - 0xff000000   ( 872 MB)</span>
</span><span class='line'><span class="s1">    lowmem  : 0xc0000000 - 0xc8000000   ( 128 MB)</span>
</span><span class='line'><span class="s1">    modules : 0xbf000000 - 0xc0000000   (  16 MB)</span>
</span><span class='line'><span class="s1">      .text : 0xc0008000 - 0xc034dd58   (3352 kB)</span>
</span><span class='line'><span class="s1">      .init : 0xc034e000 - 0xc036ae8c   ( 116 kB)</span>
</span><span class='line'><span class="s1">      .data : 0xc036c000 - 0xc0391de0   ( 152 kB)</span>
</span><span class='line'><span class="s1">       .bss : 0xc0391de0 - 0xc03ad6cc   ( 111 kB)</span>
</span><span class='line'><span class="s1">NR_IRQS:224</span>
</span><span class='line'><span class="s1">VIC @f1140000: id 0x00041190, vendor 0x41</span>
</span><span class='line'><span class="s1">FPGA IRQ chip 0 &quot;SIC&quot; @ f1003000, 13 irqs</span>
</span><span class='line'><span class="s1">Console: colour dummy device 80x30</span>
</span><span class='line'><span class="s1">Calibrating delay loop... 649.21 BogoMIPS (lpj=3246080)</span>
</span><span class='line'><span class="s1">pid_max: default: 32768 minimum: 301</span>
</span><span class='line'><span class="s1">Mount-cache hash table entries: 512</span>
</span><span class='line'><span class="s1">CPU: Testing write buffer coherency: ok</span>
</span><span class='line'><span class="s1">Setting up static identity map for 0xc0286e90 - 0xc0286ee8</span>
</span><span class='line'><span class="s1">NET: Registered protocol family 16</span>
</span><span class='line'><span class="s1">DMA: preallocated 256 KiB pool for atomic coherent allocations</span>
</span><span class='line'><span class="s1">Serial: AMBA PL011 UART driver</span>
</span><span class='line'><span class="s1">dev:f1: ttyAMA0 at MMIO 0x101f1000 (irq = 44) is a PL011 rev1</span>
</span><span class='line'><span class="s1">console [ttyAMA0] enabled</span>
</span><span class='line'><span class="s1">dev:f2: ttyAMA1 at MMIO 0x101f2000 (irq = 45) is a PL011 rev1</span>
</span><span class='line'><span class="s1">dev:f3: ttyAMA2 at MMIO 0x101f3000 (irq = 46) is a PL011 rev1</span>
</span><span class='line'><span class="s1">fpga:09: ttyAMA3 at MMIO 0x10009000 (irq = 70) is a PL011 rev1</span>
</span><span class='line'><span class="s1">bio: create slab &lt;bio-0&gt; at 0</span>
</span><span class='line'><span class="s1">Switching to clocksource timer3</span>
</span><span class='line'><span class="s1">NET: Registered protocol family 2</span>
</span><span class='line'><span class="s1">TCP established hash table entries: 1024 (order: 1, 8192 bytes)</span>
</span><span class='line'><span class="s1">TCP bind hash table entries: 1024 (order: 0, 4096 bytes)</span>
</span><span class='line'><span class="s1">TCP: Hash tables configured (established 1024 bind 1024)</span>
</span><span class='line'><span class="s1">TCP: reno registered</span>
</span><span class='line'><span class="s1">UDP hash table entries: 256 (order: 0, 4096 bytes)</span>
</span><span class='line'><span class="s1">UDP-Lite hash table entries: 256 (order: 0, 4096 bytes)</span>
</span><span class='line'><span class="s1">NET: Registered protocol family 1</span>
</span><span class='line'><span class="s1">RPC: Registered named UNIX socket transport module.</span>
</span><span class='line'><span class="s1">RPC: Registered udp transport module.</span>
</span><span class='line'><span class="s1">RPC: Registered tcp transport module.</span>
</span><span class='line'><span class="s1">RPC: Registered tcp NFSv4.1 backchannel transport module.</span>
</span><span class='line'><span class="s1">NetWinder Floating Point Emulator V0.97 (double precision)</span>
</span><span class='line'><span class="s1">Installing knfsd (copyright (C) 1996 okir@monad.swb.de).</span>
</span><span class='line'><span class="s1">jffs2: version 2.2. (NAND) © 2001-2006 Red Hat, Inc.</span>
</span><span class='line'><span class="s1">ROMFS MTD (C) 2007 Red Hat, Inc.</span>
</span><span class='line'><span class="s1">msgmni has been set to 246</span>
</span><span class='line'><span class="s1">Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254)</span>
</span><span class='line'><span class="s1">io scheduler noop registered</span>
</span><span class='line'><span class="s1">io scheduler deadline registered</span>
</span><span class='line'><span class="s1">io scheduler cfq registered (default)</span>
</span><span class='line'><span class="s1">clcd-pl11x dev:20: PL110 rev0 at 0x10120000</span>
</span><span class='line'><span class="s1">clcd-pl11x dev:20: Versatile hardware, VGA display</span>
</span><span class='line'><span class="s1">Console: switching to colour frame buffer device 80x60</span>
</span><span class='line'><span class="s1">brd: module loaded</span>
</span><span class='line'><span class="s1">physmap platform flash device: 04000000 at 34000000</span>
</span><span class='line'><span class="s1">physmap-flash.0: Found 1 x32 devices at 0x0 in 32-bit bank. Manufacturer ID 0x000000 Chip ID 0x000000</span>
</span><span class='line'><span class="s1">Intel/Sharp Extended Query Table at 0x0031</span>
</span><span class='line'><span class="s1">Using buffer write method</span>
</span><span class='line'><span class="s1">smc91x.c: v1.1, sep 22 2004 by Nicolas Pitre &lt;nico@fluxnic.net&gt;</span>
</span><span class='line'><span class="s1">eth0: SMC91C11xFD (rev 1) at c89c8000 IRQ 57 [nowait]</span>
</span><span class='line'><span class="s1">eth0: Ethernet addr: 52:54:00:12:34:56</span>
</span><span class='line'><span class="s1">mousedev: PS/2 mouse device common for all mice</span>
</span><span class='line'><span class="s1">TCP: cubic registered</span>
</span><span class='line'><span class="s1">NET: Registered protocol family 17</span>
</span><span class='line'><span class="s1">VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0</span>
</span><span class='line'><span class="s1">eth0: link up</span>
</span><span class='line'><span class="s1">Sending DHCP requests ., OK</span>
</span><span class='line'><span class="s1">IP-Config: Got DHCP answer from 192.168.1.1, my address is 192.168.1.13</span>
</span><span class='line'><span class="s1">IP-Config: Complete:</span>
</span><span class='line'><span class="s1">     device=eth0, hwaddr=52:54:00:12:34:56, ipaddr=192.168.1.13, mask=255.255.255.0, gw=192.168.1.1</span>
</span><span class='line'><span class="s1">     host=192.168.1.13, domain=, nis-domain=(none)</span>
</span><span class='line'><span class="s1">     bootserver=0.0.0.0, rootserver=192.168.1.24, rootpath=</span>
</span><span class='line'><span class="s1">     nameserver0=192.168.1.1</span>
</span><span class='line'><span class="s1">input: AT Raw Set 2 keyboard as /devices/fpga:06/serio0/input/input0</span>
</span><span class='line'><span class="s1">input: ImExPS/2 Generic Explorer Mouse as /devices/fpga:07/serio1/input/input1</span>
</span><span class='line'><span class="s1">VFS: Mounted root (nfs filesystem) on device 0:9.</span>
</span><span class='line'><span class="s1">Freeing unused kernel memory: 112K (c034e000 - c036a000)</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Please press Enter to activate this console. </span>
</span><span class='line'><span class="s1">/bin/ash: can&#39;</span>t access tty; job control turned off
</span><span class='line'>/ <span class="c"># </span>
</span></code></pre></td></tr></table></div></figure>


<p><a id="summary"></a></p>

<h3>Summary</h3>

<p>This setup need few minor tweaks like adding U-Boot environment variables
storage to not enter it every time or removing annoying message <code>can't access
tty(...)</code>. I&rsquo;m done for now, its time to take care about other challenges. I
hope that I will back to this issues in near future. If you like this series
please share it, if somethings wrong please comment I will try to help if can.</p>

<p><a href="http://bec-systems.com/site/418/how-to-set-up-a-nfs-rootfs">How to set up a NFS root filesystem for embedded Linux development</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/">0x5: Qemu network configuration and tftp for Virtual Development Board</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-07T10:36:00+02:00" pubdate data-updated="true">Jun 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Table of contents</h2>

<ul>
<li><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#intro">Introduction</a></li>
<li><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#setup-tftpd">Setup tftpd</a></li>
<li><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#qemu-networking">QEMU networking</a></li>
<li><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#verify-qemu-with-tftp">Verify all components of Virtual Development Platform</a></li>
<li><a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#what-next">What next ?</a></li>
</ul>


<p><a id="intro"></a></p>

<h3>Introduction</h3>

<p>This was not trivial task to me. As usual <code>google is your friend</code> and <code>RTFM</code> works.
First we will set tftp which we use to download modified kernel for U-Boot.
Second I will show how to setup bridged network for QEMU needs and finally we
will perform some basic test of our setup. Let&rsquo;s go.</p>

<p><a id="setup-tftpd"></a></p>

<h3>Setup tftpd</h3>

<p>First install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install tftpd tftp
</span></code></pre></td></tr></table></div></figure>


<p>Make sure that <code>/srv/tftp</code> is writable for your user. If directory doesn&rsquo;t exist
create it and give needed privileges. If you want to change some server options
edit <code>/etc/inetd.conf</code>. Copy or link our kernel to tftp server
directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /path/to/kernel/arch/arm/boot
</span><span class='line'>ln -s <span class="nv">$PWD</span>/uImage /srv/tftp/uImage
</span></code></pre></td></tr></table></div></figure>


<p>Verify if everything works correctly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span>             <span class="c"># go to home or any other directory different than arch/arm/boot</span>
</span><span class='line'>tftp 127.0.0.1 <span class="c"># connect to localhost tftp server</span>
</span><span class='line'>get uImage     <span class="c"># get kernel file</span>
</span><span class='line'>q              <span class="c"># quit tftp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check if kernel file is in current directory. If yes than you tftp server is
configured correctly, if not then google or ask me a question in comments
section.
<em>Note</em>: For Ubuntu follow instructions from
<a href="http://www.davidsudjiman.info/2006/03/27/installing-and-setting-tftpd-in-ubuntu/">here</a>.</p>

<p><a id="qemu-networking"></a></p>

<h3>QEMU networking</h3>

<p><em>Update</em>: For Ubuntu users please read <a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#ubuntu-issues">this section</a></p>

<p>I mixed <a href="http://toast.djw.org.uk/qemu.html">this</a> BKM and few other resources
that I found in the net. Setting up network depend a lot on your configuration.
I will briefly describe my situation. It is quite possible that this won&rsquo;t fit
yours.</p>

<p>I&rsquo;ve <code>eth0</code> with ip <code>10.0.2.15</code>. What I want to do is create another interface <code>tap0</code> and
bridge <code>br0</code> that will connect <code>eth0</code> and <code>tap0</code>. To do this I need few things:</p>

<ul>
<li><code>brctl</code> is provided in Debian by <code>bridge-utils</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install bridge-utils
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>check if TUN module was installed</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grep <span class="nv">CONFIG_TUN</span><span class="o">=</span> /boot/config-<span class="sb">`</span>uname -r<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>you should get <code>y</code> or <code>m</code>, if it is <code>m</code> than <code>modprobe tun</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo modprobe tun
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>create tun device</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mknod /dev/net/tun c 10 200
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>update <code>/etc/network/interfaces</code>:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># This file describes the network interfaces available on your system</span>
</span><span class='line'><span class="c"># and how to activate them. For more information, see interfaces(5).</span>
</span><span class='line'>
</span><span class='line'><span class="c"># The loopback network interface</span>
</span><span class='line'>auto lo
</span><span class='line'>iface lo inet loopback
</span><span class='line'>
</span><span class='line'><span class="c"># add br0 configuration</span>
</span><span class='line'>auto br0
</span><span class='line'>iface br0 inet dhcp
</span><span class='line'>bridge_ports eth0 <span class="c"># do not forget to attach eth0 to br0</span>
</span><span class='line'>bridge_fd 9
</span><span class='line'>bridge_hello 2
</span><span class='line'>bridge_maxage 12
</span><span class='line'>bridge_stp off
</span><span class='line'>
</span><span class='line'><span class="c"># The primary network interface</span>
</span><span class='line'>allow-hotplug eth0     <span class="c"># comment this</span>
</span><span class='line'>iface eth0 inet dhcp   <span class="c"># and this</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>use <code>/etc/qemu-ifup</code> script to bring up your network:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Executing /etc/qemu-ifup&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Bringing up $1 for bridged mode...&quot;</span>
</span><span class='line'>sudo /sbin/ifconfig <span class="nv">$1</span> 0.0.0.0 promisc up
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Adding $1 to br0...&quot;</span>
</span><span class='line'>sudo /sbin/brctl addif br0 <span class="nv">$1</span>
</span><span class='line'>sleep 2
</span></code></pre></td></tr></table></div></figure>


<p>Give executable permissions for this file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chmod +x /etc/qemu-ifup
</span></code></pre></td></tr></table></div></figure>


<p>Restart networking services locally:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service networking restart
</span></code></pre></td></tr></table></div></figure>


<p>This should prepare you environment for tftp booting in qemu.</p>

<p><a id="ubuntu-issues"></a></p>

<h4>Ubuntu issues</h4>

<p>I had experienced few problems with my Ubuntu 12.04.</p>

<ul>
<li><p>First thing was defect that cause looping u-boot during emulation in
qemu-system-arm. I checked latest qemu and version delivered in distro
repository but qemu wasn&rsquo;t issue. I tried debug problem with gdb and qemu
<code>-s -S</code> switches and find out that u-boot crashes at <code>__udivsi3</code> instruction
in <code>serial_init</code>. I tried to google this issue but found only one comment
about this on <a href="http://balau82.wordpress.com/2010/04/12/booting-linux-with-u-boot-on-qemu-arm/">Balau blog</a>:
<blockquote><p>For anyone trying to reproduce this, at least on a recent Ubuntu host, you may need to pass “-cpu all” or “-cpu cortex-a8″ to qemu. The libgcc that gets linked to u-boot appears to be compiled with thumb2 instructions which are not implemented in the Versatile cpu. I don’t get any u-boot console output without this flag, and using gdb I can see that the cpu takes an exception during <code>__udivsi3()</code> called from serial_init().</p><footer><strong>[Grant Likely]</strong></footer></blockquote>
Problem is at least 2-years old and still occurs. Unfortunately Grant&rsquo;s tricks
didn&rsquo;t help. I move to toolchain built by my own and problem was fixed. So the
moral of the story is: DO NOT USE TOOLCHAIN PROVIDED BY UBUNTU at least in
12.04.</p></li>
<li><p>Second thing also involve a lot of debugging time and when I found workaround
it was accidentally. I saw that using procedure correct for Debian on Ubuntu I
was unable to obtain any packet inside U-Boot. Network traffic analysis show
that U-Boot correctly send DHCP discovery and server reply with DHCP offer,
but bootloader behaves like no packet was received.  Static configuration also
didn&rsquo;t work. Finally I get to information how to capture traffic from inside
of emulated setup (parameter <code>-net dump,file=/path/to/file.pcap</code> do the
thing). Surprisingly for some reason adding dump param fix problem and U-Boot
received DHCP Offer and ACK. I will try to narrow down this problem for
further reading please take a look <a href="http://lists.nongnu.org/archive/html/qemu-discuss/2013-05/msg00013.html">qemu</a>
and <a href="">u-boot</a> mailing list thread.</p></li>
</ul>


<p><a id="verify-qemu-with-tftp"></a></p>

<h4>Verify all components of Virtual Development Platform</h4>

<p>So right now we should have built <a href="/blog/2013/06/07/linux-kernel-for-embedded-system">kernel uImage</a>, <a href="/blog/2013/06/07/embedded-board-bootloader">U-Boot image</a>,
<a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#qemu-networking">configured qemu network</a> and <a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/#setup-tftpd">tftp server</a>. With all this components we can
verify if our kernel booting on emulated <code>versatilepb</code>.</p>

<p>Run your qemu with network using U-Boot image as a kernel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo qemu-system-arm -kernel /path/to/u-boot/u-boot -net nic,vlan<span class="o">=</span>0 -net tap,vlan<span class="o">=</span>0,ifname<span class="o">=</span>tap0,script<span class="o">=</span>/etc/qemu-ifup -nographic -M versatilepb
</span></code></pre></td></tr></table></div></figure>


<p><em>NOTE</em>: We want to use u-boot file instead of u-boot.bin. First is ELF binary
image and second is raw binary. Raw binary image can be used with <code>-bios</code>
parameter for qemu. If you try to give raw binary as a kernel parameter it will result with error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>qemu: fatal: Trying to execute code outside RAM or ROM at 0x08000000
</span></code></pre></td></tr></table></div></figure>


<p><em>NOTE 2</em>: We have to specify <code>versatilepb</code> machine. If we forget it we will get
error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>qemu: hardware error: integratorcm_read: Unimplemented offset 0x1e0000
</span></code></pre></td></tr></table></div></figure>


<p>Right now we have u-boot booted. Let&rsquo;s set ip addresses to boot uImage from our
tftp server. For verification needs we don&rsquo;t want to <code>autoload</code> downloaded
image, so we disable this through environment variable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>setenv autoload no
</span><span class='line'>dhcp
</span><span class='line'>setenv serverip 192.168.1.2
</span><span class='line'>setenv bootfile uImage
</span><span class='line'>tftpboot
</span></code></pre></td></tr></table></div></figure>


<p>Set addresses according to your configuration. For some reason I was unable to
use u-boot <code>dhcp</code> feature. It assign me address that exist in the network.</p>

<p>We can take a close look on out downloaded image with <code>iminfo</code> command.
<code>tftpboot</code> and <code>iminfo</code> should looks like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>VersatilePB <span class="c"># tftpboot</span>
</span><span class='line'>SMC91111: PHY auto-negotiate timed out
</span><span class='line'>SMC91111: MAC 52:54:00:12:34:56
</span><span class='line'>Using SMC91111-0 device
</span><span class='line'>TFTP from server 10.0.2.15; our IP address is 10.0.2.16
</span><span class='line'>Filename <span class="s1">&#39;uImage&#39;</span>.
</span><span class='line'>Load address: 0x7fc0
</span><span class='line'>Loading: <span class="c">#################################################################</span>
</span><span class='line'>         <span class="c">#################################################################</span>
</span><span class='line'>         <span class="c">#################################################################</span>
</span><span class='line'>         <span class="c">#################################################################</span>
</span><span class='line'>         <span class="c">#################################################################</span>
</span><span class='line'>         <span class="c">##############################################</span>
</span><span class='line'>         0 Bytes/s
</span><span class='line'><span class="k">done</span>
</span><span class='line'>Bytes <span class="nv">transferred</span> <span class="o">=</span>
</span><span class='line'>1895064 <span class="o">(</span>1cea98 hex<span class="o">)</span>
</span><span class='line'>VersatilePB <span class="c"># iminfo</span>
</span><span class='line'>
</span><span class='line'><span class="c">## Checking Image at </span>
</span><span class='line'>00007fc0 ...
</span><span class='line'>    Legacy image found
</span><span class='line'>    Image Name:   Linux-3.9.0-rc8
</span><span class='line'>    Image Type:   ARM Linux Kernel Image <span class="o">(</span>uncompressed<span class="o">)</span>
</span><span class='line'>    Data Size:    1895000 <span class="nv">Bytes</span> <span class="o">=</span> 1.8 MiB
</span><span class='line'>    Load Address: 00008000
</span><span class='line'>    Entry Point:  00008000
</span><span class='line'>    Verifying Checksum ... OK
</span></code></pre></td></tr></table></div></figure>


<p>So, that what we want to see. Pretty new kernel <code>3.9.0-rc8</code> compiled as ARM
image. We can try to boot it but we will end with kernel panic because lack of
filesystem.</p>

<p><em>NOTE 3</em>: If you want to see anything after booting this image with <code>bootm</code> you
have to pass to kernel additional boot argument with serial device that should
be used as a console. Before <code>bootm</code> set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>setenv bootargs <span class="nv">console</span><span class="o">=</span>ttyAMA0
</span></code></pre></td></tr></table></div></figure>


<p>You should get something similar to below log:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>...<span class="o">)</span>
</span><span class='line'>eth0: SMC91C11xFD <span class="o">(</span>rev 1<span class="o">)</span> at c89c8000 IRQ 57 <span class="o">[</span>nowait<span class="o">]</span>
</span><span class='line'>eth0: Ethernet addr: 52:54:00:12:34:56
</span><span class='line'>mousedev: PS/2 mouse device common <span class="k">for </span>all mice
</span><span class='line'>TCP: cubic registered
</span><span class='line'>NET: Registered protocol family 17
</span><span class='line'>VFP support v0.3: implementor 41 architecture 1 part 10 variant 9 rev 0
</span><span class='line'>VFS: Cannot open root device <span class="s2">&quot;(null)&quot;</span> or unknown-block<span class="o">(</span>0,0<span class="o">)</span>: error -6
</span><span class='line'>Please append a correct <span class="s2">&quot;root=&quot;</span> boot option; here are the available partitions:
</span><span class='line'>1f00           65536 mtdblock0  <span class="o">(</span>driver?<span class="o">)</span>
</span><span class='line'>Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block<span class="o">(</span>0,0<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c0018afc&gt;<span class="o">]</span> <span class="o">(</span>unwind_backtrace+0x0/0xf0<span class="o">)</span> from <span class="o">[</span>&lt;c027af8c&gt;<span class="o">]</span> <span class="o">(</span>panic+0x80/0x1d0<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c027af8c&gt;<span class="o">]</span> <span class="o">(</span>panic+0x80/0x1d0<span class="o">)</span> from <span class="o">[</span>&lt;c0343c64&gt;<span class="o">]</span> <span class="o">(</span>mount_block_root+0x1a0/0x258<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c0343c64&gt;<span class="o">]</span> <span class="o">(</span>mount_block_root+0x1a0/0x258<span class="o">)</span> from <span class="o">[</span>&lt;c0343f08&gt;<span class="o">]</span> <span class="o">(</span>mount_root+0xf0/0x118<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c0343f08&gt;<span class="o">]</span> <span class="o">(</span>mount_root+0xf0/0x118<span class="o">)</span> from <span class="o">[</span>&lt;c0344090&gt;<span class="o">]</span> <span class="o">(</span>prepare_namespace+0x160/0x1b4<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c0344090&gt;<span class="o">]</span> <span class="o">(</span>prepare_namespace+0x160/0x1b4<span class="o">)</span> from <span class="o">[</span>&lt;c03438ec&gt;<span class="o">]</span> <span class="o">(</span>kernel_init_freeable+0x168/0x1ac<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c03438ec&gt;<span class="o">]</span> <span class="o">(</span>kernel_init_freeable+0x168/0x1ac<span class="o">)</span> from <span class="o">[</span>&lt;c027a074&gt;<span class="o">]</span> <span class="o">(</span>kernel_init+0x8/0xe4<span class="o">)</span>
</span><span class='line'><span class="o">[</span>&lt;c027a074&gt;<span class="o">]</span> <span class="o">(</span>kernel_init+0x8/0xe4<span class="o">)</span> from <span class="o">[</span>&lt;c0013df0&gt;<span class="o">]</span> <span class="o">(</span>ret_from_fork+0x14/0x24<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is expected result.</p>

<p><a id="what-next"></a></p>

<h3>What next ?</h3>

<p>We happily built basic virtual development, what we need right now is some
<a href="/blog/2013/06/07/root-file-system-for-embedded-system">initial filesystem</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/07/linux-kernel-for-embedded-system/">0x4: Linux kernel for embedded system</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-07T10:33:00+02:00" pubdate data-updated="true">Jun 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Table of contents</h2>

<ul>
<li><a href="/blog/2013/06/07/linux-kernel-for-embedded-system/#a-little-history">A little history</a></li>
<li><a href="/blog/2013/06/07/linux-kernel-for-embedded-system/#get-linux-and-build-it">Get linux and build it</a></li>
<li><a href="/blog/2013/06/07/linux-kernel-for-embedded-system/#kudos">Kudos</a></li>
</ul>


<p><a id="a-little-history"></a></p>

<h3>A little history</h3>

<p>Thinking about embedded linux probably leads to  first try of porting linux to
different architecture. I did google research (I know I should probably read
mailing list archive) and found that there were few attempt to port linux to
different platform. There is no clear information about which port of linux was
first. This is probably because many hackers didn&rsquo;t report their effort. Arguably
earliest out-of-tree version was probably for Acron A5000 (arm), Motorola 68000
(m68k) around Spring/Summer of 1994. I found also notes about SPARC port in
1993. Some sources also tells story about 1993 Amiga and Atari port. But first
port that get in to official linux tree was DEC Alpha.<a href="http://digital-domain.net/lug/unix-linux-history.html">[1]</a><a href="http://www.arm.linux.org.uk/docs/history.php">[2]</a></p>

<p>So linux is already 22 years old and first port start when it was 2-3 years old,
so we can assume it is mature enough to support most of non-x86 architectures.</p>

<p><a id="get-linux-and-build-it"></a></p>

<h3>Get linux and build it</h3>

<p>To deal with our <em>embedded</em> board we need operating system or some kind of
software that will allow us to use board features. Right now to boot system we
need at least kernel. So we have to prepare kernel for board of choice
<code>versatilepb</code>.</p>

<p>Let&rsquo;s start with cloning Linux repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</span></code></pre></td></tr></table></div></figure>


<p>and configure kernel for <code>versatilepb</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd linux
</span><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- versatile_defconfig</span></code></pre></td></tr></table></div></figure>


<p>It looks some feature is disabled in <code>versatile_defconfig</code>. I mean
<code>CONFIG_AEABI</code>. It specifies file format, data types, register usage and other
things. The main difference between EABI and ABI is that privileged instructions
are allowed in application code. More about EABI
<a href="http://en.wikipedia.org/wiki/Application_binary_interface#EABI">here</a>.
To enable this option run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig</span></code></pre></td></tr></table></div></figure>


<p>and go to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Kernel Features -&gt; Use the ARM EABI to compile the kernel</span></code></pre></td></tr></table></div></figure>


<p>We will also need DHCP and NFS support (CONFIG_IP_PNP_DHCP and CONFIG_ROOT_NFS).
First is <code>IP: DHCP support</code> and can be found under:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-&gt; Networking support (NET [=y])
</span><span class='line'>  -&gt; Networking options
</span><span class='line'>    -&gt; TCP/IP networking (INET [=y])
</span><span class='line'>      -&gt; IP: kernel level autoconfiguration (IP_PNP [=y])</span></code></pre></td></tr></table></div></figure>


<p>Second is :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-&gt; File systems
</span><span class='line'>  -&gt; Network File Systems (NETWORK_FILESYSTEMS [=y])  </span></code></pre></td></tr></table></div></figure>


<p>let&rsquo;s build image with U-Boot support.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- uImage</span></code></pre></td></tr></table></div></figure>


<p>We have kernel. How we can provide this kernel to our development environment ?
As I discuss in <a href="/blog/2013/06/07/embedded-board-bootloader">previous post</a> we
can use bare-metal qemu, but not with uImage kernel. This is special U-Boot
kernel, so easiest way will be using it with bootloader. We will figure out how
to do this in <a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board">next section</a>
about tftp and qemu network configuration.</p>

<p><strong>TODO</strong>: add picture of configuration in intro &ndash; vdb, link it here
Target configuration will consist on providing kernel through tftp server using U-Boot. Also
want to use NFS root filesystem to boot our small distro. As it is in real
development environment.</p>

<p><em>NOTE</em>: During compilation process you can encounter error like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(...)
</span><span class='line'>  UIMAGE  arch/arm/boot/uImage
</span><span class='line'>  "mkimage" command not found - U-Boot images will not be built
</span><span class='line'>  make[1]: *** [arch/arm/boot/uImage] Error 1
</span><span class='line'>  make: *** [uImage] Error 2</span></code></pre></td></tr></table></div></figure>


<p>Of course it means that we need mkimage to create U-Boot image, so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install uboot-mkimage</span></code></pre></td></tr></table></div></figure>


<p><em>Update</em>: in Debian jessie/sid this package was replaced by <code>u-boot-tools</code>.</p>

<p>We have to use uImage special build because load and execute address differes
from board to board. If we will use vmlinux image then addresses should be
manually modified. So using uImage is easiest</p>

<p><a id="kudos"></a></p>

<h3>Kudos</h3>

<p>[1] <a href="http://digital-domain.net/lug/unix-linux-history.html">UNIX/Linux History</a></br>
[2] <a href="http://www.arm.linux.org.uk/docs/history.php">The History of ARM Linux</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    Included file &#8216;custom/asides/projects.html&#8217; not found in _includes directory<section>
  <h1>About Me</h1>
  <p><img class="left" src="/assets/images/profile_photo.png" width="100" height="50">My name is Piotr Król by some known as pietrushnic. I live in Gdansk, Pomeranian District of Poland. I&#8217;m a freedom and liberty enthusiast with broad range of interests begining with linux, through austrian economics and ending with bridge. If you want to read more extroverted idle talk about me take a look <a href=/about >here</a>.
  </p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/07/root-file-system-for-embedded-system/">0x6: Root file system for embedded system</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/07/qemu-network-configuration-and-tftp-for-virtual-development-board/">0x5: Qemu network configuration and tftp for Virtual Development Board</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/07/linux-kernel-for-embedded-system/">0x4: Linux kernel for embedded system</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/07/embedded-board-bootloader/">0x3: Embedded board bootloader</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/07/toolchain-for-virtual-development-board/">0x2: Toolchain for Virtual Development Board</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pietrushnic">@pietrushnic</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pietrushnic',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/pietrushnic@gmail.com?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - pietrushnic -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pietrushnicsworld';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
